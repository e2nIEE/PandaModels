<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Run Optimal MultiNetwork Storage · PandaModels</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://e2nIEE.github.io/PandaModels.jl/stable/omns/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">PandaModels</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../quickguide/">Getting Started</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../pptutorial/">Optimazion Problems</a></li></ul></li><li><span class="tocitem">Developer</span><ul><li><a class="tocitem" href="../develop/">Develop Mode</a></li><li><a class="tocitem" href="../test/">Add Test</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Run Optimal MultiNetwork Storage</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Run Optimal MultiNetwork Storage</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/e2nIEE/PandaModels.jl/blob/master/docs/src/omns.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Run-Optimal-MultiNetwork-Storage"><a class="docs-heading-anchor" href="#Run-Optimal-MultiNetwork-Storage">Run Optimal MultiNetwork Storage</a><a id="Run-Optimal-MultiNetwork-Storage-1"></a><a class="docs-heading-anchor-permalink" href="#Run-Optimal-MultiNetwork-Storage" title="Permalink"></a></h1><p>This tutorial describes how to run a <a href="https://lanl-ansi.github.io/PowerModels.jl/stable/storage/">storage optimization</a> over <a href="https://lanl-ansi.github.io/PowerModels.jl/stable/multi-networks/">multiple timesteps</a> with a PowerModels.jl multinetwork together with pandapower.</p><p>To run a storage optimization over multiple time steps, the power system data is copied n_timestep times internally. This is done efficiently in a julia script. Each network in the multinetwork dict represents a single time step. The input time series must be written to the loads and generators accordingly to each network. This is currently done by converting input time series to a dict, saving it as a json file and loading the data back in julia. This &quot;hack&quot; is probably just a temporary solution.</p><p>Some notes:</p><ul><li>only storages which are set as &quot;controllable&quot; are optimized</li><li>time series can be written to load / sgen elements only at the moment</li><li>output of the optimization is a dict containing pandas DataFrames for every optimized storage and time step   </li></ul><h3 id="Run-the-storage-optimization"><a class="docs-heading-anchor" href="#Run-the-storage-optimization">Run the storage optimization</a><a id="Run-the-storage-optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Run-the-storage-optimization" title="Permalink"></a></h3><p>In order to start the optimization and visualize results, we follow four steps:</p><ol><li>Load the pandapower grid data (here the cigre MV grid)</li><li>Convert the time series to the dict</li><li>Start the optimization</li><li>plot the results</li></ol><h4 id="Get-the-grid-data"><a class="docs-heading-anchor" href="#Get-the-grid-data">Get the grid data</a><a id="Get-the-grid-data-1"></a><a class="docs-heading-anchor-permalink" href="#Get-the-grid-data" title="Permalink"></a></h4><p>We load the cigre medium voltage grid with &quot;pv&quot; and &quot;wind&quot; generators. Also we set some limits and add a storage with <strong>controllable</strong> == True</p><pre><code class="language-python hljs">import json
import os
import tempfile

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

import pandapower as pp
import pandapower.networks as nw

def cigre_grid():
    net = nw.create_cigre_network_mv(&quot;pv_wind&quot;)
    # set some limits
    min_vm_pu = 0.95
    max_vm_pu = 1.05

    net[&quot;bus&quot;].loc[:, &quot;min_vm_pu&quot;] = min_vm_pu
    net[&quot;bus&quot;].loc[:, &quot;max_vm_pu&quot;] = max_vm_pu

    net[&quot;line&quot;].loc[:, &quot;max_loading_percent&quot;] = 100.

    # close all switches
    net.switch.loc[:, &quot;closed&quot;] = True
    # add storage to bus 10
    pp.create_storage(net, 10, p_mw=0.5, max_e_mwh=.2, soc_percent=0., q_mvar=0., controllable=True)

    return net

</code></pre><h4 id="Convert-the-time-series-to-a-dict"><a class="docs-heading-anchor" href="#Convert-the-time-series-to-a-dict">Convert the time series to a dict</a><a id="Convert-the-time-series-to-a-dict-1"></a><a class="docs-heading-anchor-permalink" href="#Convert-the-time-series-to-a-dict" title="Permalink"></a></h4><p>The following functions loads the example time series from the input_file and scales the power accordingly. It then stores the dict to a json file to a temporary folder.</p><pre><code class="language-python hljs">def convert_timeseries_to_dict(net, input_file):
    # set the load type in the cigre grid, since it is not specified
    net[&quot;load&quot;].loc[:, &quot;type&quot;] = &quot;residential&quot;
    # change the type of the last sgen to wind
    net.sgen.loc[:, &quot;type&quot;] = &quot;pv&quot;
    net.sgen.loc[8, &quot;type&quot;] = &quot;wind&quot;

    # read the example time series
    time_series = pd.read_json(input_file)
    time_series.sort_index(inplace=True)
    # this example time series has a 15min resolution with 96 time steps for one day
    n_timesteps = time_series.shape[0]

    n_load = len(net.load)
    n_sgen = len(net.sgen)
    p_timeseries = np.zeros((n_timesteps, n_load + n_sgen), dtype=float)
    # p
    load_p = net[&quot;load&quot;].loc[:, &quot;p_mw&quot;].values
    sgen_p = net[&quot;sgen&quot;].loc[:7, &quot;p_mw&quot;].values
    wind_p = net[&quot;sgen&quot;].loc[8, &quot;p_mw&quot;]

    p_timeseries_dict = dict()
    for t in range(n_timesteps):
        # print(time_series.at[t, &quot;residential&quot;])
        p_timeseries[t, :n_load] = load_p * time_series.at[t, &quot;residential&quot;]
        p_timeseries[t, n_load:-1] = - sgen_p * time_series.at[t, &quot;pv&quot;]
        p_timeseries[t, -1] = - wind_p * time_series.at[t, &quot;wind&quot;]
        p_timeseries_dict[t] = p_timeseries[t, :].tolist()

    time_series_file = os.path.join(tempfile.gettempdir(), &quot;timeseries.json&quot;)
    with open(time_series_file, &#39;w&#39;) as fp:
        json.dump(p_timeseries_dict, fp)

    return net, p_timeseries_dict
</code></pre><h4 id="Start-the-optimization"><a class="docs-heading-anchor" href="#Start-the-optimization">Start the optimization</a><a id="Start-the-optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Start-the-optimization" title="Permalink"></a></h4><p>Here we start the optimization for the 15min resolution time series. Since we have 96 time steps and 15 min resolution we set n<em>timesteps=96 and time</em>elapsed=.25 as a quarter of an hour.</p><pre><code class="language-python hljs"># open the cigre mv grid
net = cigre_grid()
# convert the time series to a dict and save it to disk
input_file = &quot;assets/cigre_timeseries_15min.json&quot;
net, p_timeseries = convert_timeseries_to_dict(net, input_file)
# run the PowerModels.jl optimization
# n_time steps = 96 and time_elapsed is a quarter of an hour (since the time series are in 15min resolution)
storage_results = pp.runpm_storage_opf(net, n_timesteps=96, time_elapsed=0.25)
</code></pre><h4 id="Store-the-results-(optionally)"><a class="docs-heading-anchor" href="#Store-the-results-(optionally)">Store the results (optionally)</a><a id="Store-the-results-(optionally)-1"></a><a class="docs-heading-anchor-permalink" href="#Store-the-results-(optionally)" title="Permalink"></a></h4><p>Store the results to a json file</p><pre><code class="language-python hljs">def store_results(storage_results, grid_name):
    for key, val in storage_results.items():
        file = grid_name + &quot;_strg_res&quot; + str(key) + &quot;.json&quot;
        print(&quot;Storing results to file {}&quot;.format(file))
        print(val)
        val.to_json(file)
# store the results to disk optionally
store_results(storage_results, &quot;cigre_ts&quot;)
</code></pre><h3 id="Plot-the-results"><a class="docs-heading-anchor" href="#Plot-the-results">Plot the results</a><a id="Plot-the-results-1"></a><a class="docs-heading-anchor-permalink" href="#Plot-the-results" title="Permalink"></a></h3><p>Plot the optimization results for the storage.</p><pre><code class="language-python hljs">def plot_storage_results(storage_results):
    n_res = len(storage_results.keys())
    fig, axes = plt.subplots(n_res, 2)
    if n_res == 1:
        axes = [axes]
    for i, (key, val) in enumerate(storage_results.items()):
        res = val
        axes[i][0].set_title(&quot;Storage {}&quot;.format(key))
        el = res.loc[:, [&quot;p_mw&quot;, &quot;q_mvar&quot;, &quot;soc_mwh&quot;]]
        el.plot(ax=axes[i][0])
        axes[i][0].set_xlabel(&quot;time step&quot;)
        axes[i][0].legend(loc=4)
        axes[i][0].grid()
        ax2 = axes[i][1]
        patch = plt.plot([], [], ms=8, ls=&quot;--&quot;, mec=None, color=&quot;grey&quot;, label=&quot;{:s}&quot;.format(&quot;soc_percent&quot;))
        ax2.legend(handles=patch)
        ax2.set_label(&quot;SOC percent&quot;)
        res.loc[:, &quot;soc_percent&quot;].plot(ax=ax2, linestyle=&quot;--&quot;, color=&quot;grey&quot;)
        ax2.grid()

    plt.show()
# plot the result
plot_storage_results(storage_results)</code></pre></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.15 on <span class="colophon-date" title="Thursday 17 March 2022 15:53">Thursday 17 March 2022</span>. Using Julia version 1.5.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
